<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using MetalKit part 14</title>
  <meta name="description" content="Let’s pick up where we left off in Part 13. Using the same playground we worked on last time, we will learn about noise today. From Wikipedia: Noise refers t...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" href="https://devimages.apple.com.edgekey.net/assets/elements/icons/metal/metal-128x128_2x.png" />
  <link rel="canonical" href="http://localhost:4000/2016/06/01/using-metalkit-part-14.html">
  <link rel="alternate" type="application/rss+xml" title="The Metal Framework" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">The Metal Framework</a>

    <nav class="site-nav">
    
    <!--
      <a href="/archive.html" style="color:grey;">Archives</a>&nbsp;&nbsp;&nbsp;
    -->
    
      <a href="/contact.html" style="color:grey;">Contact</a>&nbsp;&nbsp;&nbsp;
      <a href="/feed.xml" style="color:grey;">RSS</a>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Using MetalKit part 14</h1>
    <p class="post-meta"><time datetime="2016-06-01T00:00:00-05:00" itemprop="datePublished">Jun 1, 2016</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href = "https://twitter.com/MTLDevice" target="_blank">Marius Horga</a></span></span></p>
  </header>

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script><br /><br />

  <div class="post-content" itemprop="articleBody">
    <p>Let’s pick up where we left off in <a href="http://metalkit.org/2016/05/25/using-metalkit-part-13.html">Part 13</a>. Using the same playground we worked on last time, we will learn about <strong>noise</strong> today. From <em>Wikipedia</em>:</p>

<blockquote>
  <p><code class="highlighter-rouge">Noise</code> refers to any random fluctuations of data that makes the perception of an expected signal, difficult. <code class="highlighter-rouge">Value noise</code> is a type of noise commonly used as a procedural texture primitive in computer graphics. This method consists of the creation of a lattice of points which are assigned random values. The noise function then returns the interpolated number based on the values of the surrounding lattice points. Multiple octaves of this noise can be generated and then summed together in order to create a form of fractal noise.</p>
</blockquote>

<p>The most obvious characteristic of noise is randomness. Since <code class="highlighter-rouge">MSL</code> does not provide a random function let’s just create one ourselves. What we need is a random number between <strong>[0, 1]</strong>. We can get that by using the <code class="highlighter-rouge">fract</code> function which returns the fractional component of a number:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">float</span> <span class="nf">random</span><span class="p">(</span><span class="n">float2</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">fract</span><span class="p">(</span><span class="nf">sin</span><span class="p">(</span><span class="nf">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nf">float2</span><span class="p">(</span><span class="mf">15.79</span><span class="p">,</span> <span class="mf">81.93</span><span class="p">))</span> <span class="o">*</span> <span class="mf">45678.9123</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure>

<p>The <strong>noise()</strong> function will bilinearly interpolate a lattice (grid) and return a smoothed value. Bilinear interpolation allows us to transform our <strong>1D</strong> <code class="highlighter-rouge">random</code> function to a value based on a <strong>2D</strong> grid:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">float</span> <span class="nf">noise</span><span class="p">(</span><span class="n">float2</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">float2</span> <span class="n">i</span> <span class="o">=</span> <span class="nf">floor</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">float2</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">fract</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">f</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">bottom</span> <span class="o">=</span> <span class="nf">mix</span><span class="p">(</span><span class="nf">random</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="nf">float2</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="nf">random</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="nf">float2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span> <span class="n">f</span><span class="o">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">top</span> <span class="o">=</span> <span class="nf">mix</span><span class="p">(</span><span class="nf">random</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="nf">float2</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span> <span class="nf">random</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="nf">float2</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">f</span><span class="o">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">t</span> <span class="o">=</span> <span class="nf">mix</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">y</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>We first use <strong>i</strong> to move along grid points and <strong>f</strong> as an offset between the grid points. Then we calculate a <strong>Cubic Hermite Spline</strong> with the formula <code class="highlighter-rouge">3f^2 - 2f^3</code> and which creates a S-shaped curve that has values between <strong>[0, 1]</strong>. Next we interpolate values along the bottom and top of the grid, and finally we interpolate the vertical line between those 2 horizontal points to get our final value for noise.</p>

<p>Next we create a <strong>Fractional Brownian Motion</strong> function that calls our <code class="highlighter-rouge">noise()</code> function multiple times and adds up the results.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">float</span> <span class="nf">fbm</span><span class="p">(</span><span class="n">float2</span> <span class="n">uv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">float</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">amp</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="nf">noise</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">amp</span><span class="p">;</span>
        <span class="n">uv</span> <span class="o">+=</span> <span class="n">uv</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">;</span>
        <span class="n">amp</span> <span class="o">*=</span> <span class="mf">0.4</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>By adding various (four – in this case) <code class="highlighter-rouge">octaves</code> of this noise at different amplitudes (as explained in the beginning), we can generate a simple cloud-like pattern. We have one more thing to do: inside the kernel replace all the lines after the one where <code class="highlighter-rouge">distance</code> is defined, with these lines:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">uv</span> <span class="o">=</span> <span class="nf">fmod</span><span class="p">(</span><span class="n">uv</span> <span class="o">+</span> <span class="nf">float2</span><span class="p">(</span><span class="n">timer</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nf">float2</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">));</span>
<span class="n">float</span> <span class="n">t</span> <span class="o">=</span> <span class="nf">fbm</span><span class="p">(</span> <span class="n">uv</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">);</span>
<span class="n">output</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">?</span> <span class="nf">float4</span><span class="p">(</span><span class="nf">float3</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="nf">float4</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">gid</span><span class="p">);</span></code></pre></figure>

<p>For fun, we add the <code class="highlighter-rouge">timer</code> uniform again to animate the content. The output image should look like this:</p>

<p><img src="https://github.com/MetalKit/images/raw/master/chapter14.gif" alt="alt text" title="chapter 14" /></p>

<p>It looks cool, but still not realistic enough. To make it look even more realistic we need to learn about, and apply a texture. You can read more about <a href="http://www.scratchapixel.com/old/lessons/3d-advanced-lessons/interpolation/bilinear-interpolation">bilinear filtering</a>, about <a href="http://www.scratchapixel.com/old/lessons/3d-advanced-lessons/noise-part-1/creating-a-simple-2d-noise">value noise</a> and about <a href="https://en.wikipedia.org/wiki/Fractional_Brownian_motion">Fractional Brownian motion</a> if you’re interested. You can also see an example of the <a href="https://www.desmos.com/calculator/mnrgw3yias">Cubic Hermit Spline</a>. The <a href="https://github.com/MetalKit/metal">source code</a> is posted on Github as usual.</p>

<p>Until next time!</p>

  </div>

  <!-- 
    

   -->

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style"><br />
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script>
</article>
      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper" align="center">

    <!-- <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p> -->

    <!-- Begin MailChimp Signup Form --><p>
    <link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
    <style type="text/css">
      #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    </style>
    <div id="mc_embed_signup">
      <form action="//github.us12.list-manage.com/subscribe/post?u=5daab344aba23020915a23c29&amp;id=69e4a7c3af" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Subscribe to be notified of new posts.</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
          <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_5daab344aba23020915a23c29_69e4a7c3af" tabindex="-1" value=""></div>
          <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
          </div>
      </form>
    </div>
    </p><!--End mc_embed_signup-->

    <!-- <h2 class="footer-heading">The Metal Framework</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p>
        <ul class="contact-list">
          <li>
            
              The Metal Framework
            
            </li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/MetalKit"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">MetalKit</span></a>

          </li>
          
          
          <li>
            <a href="https://twitter.com/gpu3d"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">gpu3d</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        
          <a href="https://twitter.com/gpu3d"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">gpu3d</span></a>

        
        <p>Resources and tutorials for Metal, MetalKit and Metal Performance Shaders.
</p>
      </div>
    </div> -->

  </div>

</footer>


  </body>

</html>
