<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ray tracing in a Swift playground part 2</title>
  <meta name="description" content="Let’s continue working on our ray tracer and pick up where we left off last week. I want to thank Caroline, Jessy, Jeff and Mike for providing valuable feedb...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/MetalKit/images/master/metal_ico.png" />
  <link rel="canonical" href="http://localhost:4000/2016/03/28/ray-tracing-in-a-swift-playground-part-2.html">
  <link rel="alternate" type="application/rss+xml" title="The Metal Framework" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">The Metal Framework</a>

    <nav class="site-nav">
    
    <!--
      <a href="/archive.html" style="color:grey;">Archives</a>&nbsp;&nbsp;&nbsp;
    -->
    
      <a href="/contact.html" style="color:grey;">Contact</a>&nbsp;&nbsp;&nbsp;
      <a href="/feed.xml" style="color:grey;">RSS</a>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Ray tracing in a Swift playground part 2</h1>
    <p class="post-meta"><time datetime="2016-03-28T00:00:00-05:00" itemprop="datePublished">Mar 28, 2016</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href = "https://twitter.com/gpu3d" target="_blank">Marius Horga</a></span></span></p>
  </header>

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script><br /><br />

  <div class="post-content" itemprop="articleBody">
    <p>Let’s continue working on our <code class="highlighter-rouge">ray tracer</code> and pick up where we left off last week. I want to thank <code class="highlighter-rouge">Caroline</code>, <code class="highlighter-rouge">Jessy</code>, <code class="highlighter-rouge">Jeff</code> and <code class="highlighter-rouge">Mike</code> for providing valuable feedback and performance improvement suggestions while working on this project.</p>

<p>First, as usual, we will do some code cleanup. In the first part we used the <strong>vec3.swift</strong> class because we wanted to understand the underlying data structures and operations between them, however, there is already a framework called <strong>simd</strong> which helps us do all the <code class="highlighter-rouge">math</code> we need. So rename <code class="highlighter-rouge">vec3.swift</code> to <strong>ray.swift</strong> since this class will only contain code related to the <code class="highlighter-rouge">ray</code> struct. Next, delete the <code class="highlighter-rouge">vec3</code> struct as well as all the operations at the end. You should only retain the <strong>ray</strong> struct, as well as the <strong>color</strong> function.</p>

<p>Next, import the <strong>simd</strong> framework and then replace <code class="highlighter-rouge">vec3</code> with <strong>float3</strong> everywhere inside this file, and after that go to <strong>pixel.swift</strong> and repeat this last step in there as well. We are now officially depending on <strong>float3</strong> only! While still in the <code class="highlighter-rouge">pixel.swift</code> we need to address one more concern: passing the array between the two functions makes the rendering quite slow. Here is how to time your code in the playground:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">let</span> <span class="nv">width</span> <span class="o">=</span> <span class="mi">800</span>
<span class="k">let</span> <span class="nv">height</span> <span class="o">=</span> <span class="mi">400</span>
<span class="k">let</span> <span class="nv">t0</span> <span class="o">=</span> <span class="kt">CFAbsoluteTimeGetCurrent</span><span class="p">()</span>
<span class="k">var</span> <span class="nv">pixelSet</span> <span class="o">=</span> <span class="nf">makePixelSet</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
<span class="k">var</span> <span class="nv">image</span> <span class="o">=</span> <span class="nf">imageFromPixels</span><span class="p">(</span><span class="n">pixelSet</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">t1</span> <span class="o">=</span> <span class="kt">CFAbsoluteTimeGetCurrent</span><span class="p">()</span>
<span class="n">t1</span><span class="o">-</span><span class="n">t0</span>
<span class="n">image</span></code></pre></figure>

<p>Notice it takes <strong>5 seconds</strong> (at least that is my case). This happens because in <code class="highlighter-rouge">Swift</code> arrays are defined as structs actually, and structs are always passed <code class="highlighter-rouge">by value</code> in Swift which means a copy of the array will me made when passing it, and copying a huge array is a performance bottleneck. There are two ways to fix this. One, the most elegant, is to wrap everything inside a <code class="highlighter-rouge">class</code> and make the array a class <code class="highlighter-rouge">property</code>. This way, the array would not need to be passed anymore between the local functions. The second way, is easier to implement and we will go with this one to save space in this article. All we need to do is combine the two functions into one like this:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">public</span> <span class="kd">func</span> <span class="nf">imageFromPixels</span><span class="p">(</span><span class="nv">width</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="n">_</span> <span class="nv">height</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">CIImage</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">pixel</span> <span class="o">=</span> <span class="kt">Pixel</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">green</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">blue</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">var</span> <span class="nv">pixels</span> <span class="o">=</span> <span class="p">[</span><span class="kt">Pixel</span><span class="p">](</span><span class="nv">count</span><span class="p">:</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">,</span> <span class="nv">repeatedValue</span><span class="p">:</span> <span class="n">pixel</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">lower_left_corner</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="c1">// Y is reversed
</span>
    <span class="k">let</span> <span class="nv">horizontal</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">vertical</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">origin</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">width</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">height</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">u</span> <span class="o">=</span> <span class="kt">Float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="kt">Float</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">v</span> <span class="o">=</span> <span class="kt">Float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="kt">Float</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">r</span> <span class="o">=</span> <span class="nf">ray</span><span class="p">(</span><span class="nv">origin</span><span class="p">:</span> <span class="n">origin</span><span class="p">,</span> <span class="nv">direction</span><span class="p">:</span> <span class="n">lower_left_corner</span> <span class="o">+</span> <span class="n">u</span> <span class="o">*</span> <span class="n">horizontal</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">vertical</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">col</span> <span class="o">=</span> <span class="nf">color</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">pixel</span> <span class="o">=</span> <span class="kt">Pixel</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="nv">green</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="nv">blue</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span>
            <span class="n">pixels</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">let</span> <span class="nv">bitsPerComponent</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">let</span> <span class="nv">bitsPerPixel</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="k">let</span> <span class="nv">rgbColorSpace</span> <span class="o">=</span> <span class="kt">CGColorSpaceCreateDeviceRGB</span><span class="p">()</span>
    <span class="k">let</span> <span class="nv">bitmapInfo</span> <span class="o">=</span> <span class="kt">CGBitmapInfo</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="kt">CGImageAlphaInfo</span><span class="o">.</span><span class="kt">PremultipliedLast</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">providerRef</span> <span class="o">=</span> <span class="kt">CGDataProviderCreateWithCFData</span><span class="p">(</span><span class="kt">NSData</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="n">pixels</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">pixels</span><span class="o">.</span><span class="n">count</span> <span class="o">*</span> <span class="nf">sizeof</span><span class="p">(</span><span class="kt">Pixel</span><span class="p">)))</span>
    <span class="k">let</span> <span class="nv">image</span> <span class="o">=</span> <span class="kt">CGImageCreate</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">bitsPerComponent</span><span class="p">,</span> <span class="n">bitsPerPixel</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="nf">sizeof</span><span class="p">(</span><span class="kt">Pixel</span><span class="p">),</span> <span class="n">rgbColorSpace</span><span class="p">,</span> <span class="n">bitmapInfo</span><span class="p">,</span> <span class="n">providerRef</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kt">CGColorRenderingIntent</span><span class="o">.</span><span class="kt">RenderingIntentDefault</span><span class="p">)</span>
    <span class="k">return</span> <span class="kt">CIImage</span><span class="p">(</span><span class="kt">CGImage</span><span class="p">:</span> <span class="n">image</span><span class="o">!</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>Let’s time the execution again:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">let</span> <span class="nv">width</span> <span class="o">=</span> <span class="mi">800</span>
<span class="k">let</span> <span class="nv">height</span> <span class="o">=</span> <span class="mi">400</span>
<span class="k">let</span> <span class="nv">t0</span> <span class="o">=</span> <span class="kt">CFAbsoluteTimeGetCurrent</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">image</span> <span class="o">=</span> <span class="nf">imageFromPixels</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">t1</span> <span class="o">=</span> <span class="kt">CFAbsoluteTimeGetCurrent</span><span class="p">()</span>
<span class="n">t1</span><span class="o">-</span><span class="n">t0</span>
<span class="n">image</span></code></pre></figure>

<p>Much better! In my case the running time went from <code class="highlighter-rouge">5 seconds</code> down to only <strong>0.1 seconds</strong>. Ok, enough with the cleanup. Let’s do some graphics instead! We would like to draw more than just one sphere, perhaps way many more spheres. One neat trick to simulate the horizon if to draw a really huge sphere. Then we can put our smaller sphere on top of it to achieve a <code class="highlighter-rouge">sitting-on-the-ground</code> effect.</p>

<p>For this, we need to abstract our current sphere code into a generic class. Let’s name it <strong>objects.swift</strong> since we will probably create other type of volumes in future beside spheres. Next, inside <code class="highlighter-rouge">objects.swift</code> we need to create a new struct which represents a <code class="highlighter-rouge">hit</code> event:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="n">hit_record</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">t</span><span class="p">:</span> <span class="kt">Float</span>
    <span class="k">var</span> <span class="nv">p</span><span class="p">:</span> <span class="n">float3</span>
    <span class="k">var</span> <span class="nv">normal</span><span class="p">:</span> <span class="n">float3</span>
    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Next, we need to create a protocol named <strong>hitable</strong> so various classes can conform to. This protocol only contains the <strong>hit</strong> function:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">protocol</span> <span class="n">hitable</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">hit</span><span class="p">(</span><span class="nv">r</span><span class="p">:</span> <span class="n">ray</span><span class="p">,</span> <span class="n">_</span> <span class="nv">tmin</span><span class="p">:</span> <span class="kt">Float</span><span class="p">,</span> <span class="n">_</span> <span class="nv">tmax</span><span class="p">:</span> <span class="kt">Float</span><span class="p">,</span> <span class="k">inout</span> <span class="n">_</span> <span class="nv">rec</span><span class="p">:</span> <span class="n">hit_record</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="p">}</span></code></pre></figure>

<p>The next obvious step is to implement a <strong>sphere</strong> class:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nv">sphere</span><span class="p">:</span> <span class="n">hitable</span>  <span class="p">{</span>
    <span class="k">var</span> <span class="nv">center</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">var</span> <span class="nv">radius</span> <span class="o">=</span> <span class="kt">Float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">c</span><span class="p">:</span> <span class="n">float3</span><span class="p">,</span> <span class="nv">r</span><span class="p">:</span> <span class="kt">Float</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">r</span>
    <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">hit</span><span class="p">(</span><span class="nv">r</span><span class="p">:</span> <span class="n">ray</span><span class="p">,</span> <span class="n">_</span> <span class="nv">tmin</span><span class="p">:</span> <span class="kt">Float</span><span class="p">,</span> <span class="n">_</span> <span class="nv">tmax</span><span class="p">:</span> <span class="kt">Float</span><span class="p">,</span> <span class="k">inout</span> <span class="n">_</span> <span class="nv">rec</span><span class="p">:</span> <span class="n">hit_record</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">oc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">origin</span> <span class="o">-</span> <span class="n">center</span>
        <span class="k">let</span> <span class="nv">a</span> <span class="o">=</span> <span class="nf">dot</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">b</span> <span class="o">=</span> <span class="nf">dot</span><span class="p">(</span><span class="n">oc</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">c</span> <span class="o">=</span> <span class="nf">dot</span><span class="p">(</span><span class="n">oc</span><span class="p">,</span> <span class="n">oc</span><span class="p">)</span> <span class="o">-</span> <span class="n">radius</span><span class="o">*</span><span class="n">radius</span>
        <span class="k">let</span> <span class="nv">discriminant</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">discriminant</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">var</span> <span class="nv">t</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">discriminant</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">a</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tmin</span> <span class="p">{</span>
                <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">+</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">discriminant</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">a</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">tmin</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tmax</span> <span class="p">{</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="nf">point_at_parameter</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">normal</span> <span class="o">=</span> <span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">p</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="nf">float3</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>As you might notice, the <code class="highlighter-rouge">hit</code> function is quite similar to the <strong>hit_sphere</strong> function we deleted from <code class="highlighter-rouge">ray.swift</code>, except we are now looking at hits that only occur during the interval <code class="highlighter-rouge">tmax - tmin</code>. Next, we need a way to add multiple objects to a list. An array of <code class="highlighter-rouge">hitables</code> seems to be the right choice:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nv">hitable_list</span><span class="p">:</span> <span class="n">hitable</span>  <span class="p">{</span>
    <span class="k">var</span> <span class="nv">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">hitable</span><span class="p">]()</span>
    <span class="kd">func</span> <span class="nf">add</span><span class="p">(</span><span class="nv">h</span><span class="p">:</span> <span class="n">hitable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">list</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">hit</span><span class="p">(</span><span class="nv">r</span><span class="p">:</span> <span class="n">ray</span><span class="p">,</span> <span class="n">_</span> <span class="nv">tmin</span><span class="p">:</span> <span class="kt">Float</span><span class="p">,</span> <span class="n">_</span> <span class="nv">tmax</span><span class="p">:</span> <span class="kt">Float</span><span class="p">,</span> <span class="k">inout</span> <span class="n">_</span> <span class="nv">rec</span><span class="p">:</span> <span class="n">hit_record</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">hit_anything</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">list</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="nf">hit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">hit_anything</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">hit_anything</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Back to <code class="highlighter-rouge">ray.swift</code>, we need to modify the <code class="highlighter-rouge">color</code> function to factor a <code class="highlighter-rouge">hit-record</code> variable into the color calculation:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">color</span><span class="p">(</span><span class="nv">r</span><span class="p">:</span> <span class="n">ray</span><span class="p">,</span> <span class="nv">world</span><span class="p">:</span> <span class="n">hitable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">float3</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">rec</span> <span class="o">=</span> <span class="nf">hit_record</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">world</span><span class="o">.</span><span class="nf">hit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kt">Float</span><span class="o">.</span><span class="n">infinity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nf">float3</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">normal</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">normal</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">normal</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">unit_direction</span> <span class="o">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">t</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">unit_direction</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nf">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Finally, back to <code class="highlighter-rouge">pixel.swift</code> we need to change the <code class="highlighter-rouge">imageFromPixels</code> function to allow the including of more objects:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">public</span> <span class="kd">func</span> <span class="nf">imageFromPixels</span><span class="p">(</span><span class="nv">width</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="n">_</span> <span class="nv">height</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">CIImage</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="k">let</span> <span class="nv">world</span> <span class="o">=</span> <span class="nf">hitable_list</span><span class="p">()</span>
    <span class="k">var</span> <span class="nv">object</span> <span class="o">=</span> <span class="nf">sphere</span><span class="p">(</span><span class="nv">c</span><span class="p">:</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="o">-</span><span class="mf">100.5</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nv">r</span><span class="p">:</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">world</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
    <span class="n">object</span> <span class="o">=</span> <span class="nf">sphere</span><span class="p">(</span><span class="nv">c</span><span class="p">:</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nv">r</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">world</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">width</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">height</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">u</span> <span class="o">=</span> <span class="kt">Float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="kt">Float</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">v</span> <span class="o">=</span> <span class="kt">Float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="kt">Float</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">r</span> <span class="o">=</span> <span class="nf">ray</span><span class="p">(</span><span class="nv">origin</span><span class="p">:</span> <span class="n">origin</span><span class="p">,</span> <span class="nv">direction</span><span class="p">:</span> <span class="n">lower_left_corner</span> <span class="o">+</span> <span class="n">u</span> <span class="o">*</span> <span class="n">horizontal</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">vertical</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">col</span> <span class="o">=</span> <span class="nf">color</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nv">world</span><span class="p">:</span> <span class="n">world</span><span class="p">)</span>
            <span class="n">pixel</span> <span class="o">=</span> <span class="kt">Pixel</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="nv">green</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="nv">blue</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span>
            <span class="n">pixels</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="o">...</span>
<span class="p">}</span></code></pre></figure>

<p>In the main playground page, see the generated new image:</p>

<p><img src="https://github.com/metalkit/images/raw/master/raytracing3.png" alt="alt text" title="Raytracing 3" /></p>

<p>Nice! If you look closely you will notice the edges exhibit the <code class="highlighter-rouge">aliasing</code> effect, and this happens because we do not have any blending of colors for the pixels on the edge. To overcome this, we need to sample the color multiple times by randomly generating values that are within the range we want, so we can blend them together and achieve an <code class="highlighter-rouge">anti-aliasing</code> effect.</p>

<p>But first, let’s also create a <strong>camera</strong> class inside <code class="highlighter-rouge">ray.swift</code> as it will turn handy later. Practically, we just move the improvised camera we had inside the <code class="highlighter-rouge">imageFromPixels</code> function and put it in its right place:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="n">camera</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">lower_left_corner</span><span class="p">:</span> <span class="n">float3</span>
    <span class="k">let</span> <span class="nv">horizontal</span><span class="p">:</span> <span class="n">float3</span>
    <span class="k">let</span> <span class="nv">vertical</span><span class="p">:</span> <span class="n">float3</span>
    <span class="k">let</span> <span class="nv">origin</span><span class="p">:</span> <span class="n">float3</span>
    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">lower_left_corner</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">horizontal</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">vertical</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">get_ray</span><span class="p">(</span><span class="nv">u</span><span class="p">:</span> <span class="kt">Float</span><span class="p">,</span> <span class="n">_</span> <span class="nv">v</span><span class="p">:</span> <span class="kt">Float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ray</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">ray</span><span class="p">(</span><span class="nv">origin</span><span class="p">:</span> <span class="n">origin</span><span class="p">,</span> <span class="nv">direction</span><span class="p">:</span> <span class="n">lower_left_corner</span> <span class="o">+</span> <span class="n">u</span> <span class="o">*</span> <span class="n">horizontal</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">vertical</span> <span class="o">-</span> <span class="n">origin</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The <code class="highlighter-rouge">imageFromPixels</code> function now looks like this:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">public</span> <span class="kd">func</span> <span class="nf">imageFromPixels</span><span class="p">(</span><span class="nv">width</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="n">_</span> <span class="nv">height</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">CIImage</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="k">let</span> <span class="nv">cam</span> <span class="o">=</span> <span class="nf">camera</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">width</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">height</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">ns</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="k">var</span> <span class="nv">col</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">ns</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">u</span> <span class="o">=</span> <span class="p">(</span><span class="kt">Float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="kt">Float</span><span class="p">(</span><span class="nf">drand48</span><span class="p">()))</span> <span class="o">/</span> <span class="kt">Float</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
                <span class="k">let</span> <span class="nv">v</span> <span class="o">=</span> <span class="p">(</span><span class="kt">Float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="kt">Float</span><span class="p">(</span><span class="nf">drand48</span><span class="p">()))</span> <span class="o">/</span> <span class="kt">Float</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
                <span class="k">let</span> <span class="nv">r</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="nf">get_ray</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">+=</span> <span class="nf">color</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">world</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">col</span> <span class="o">/=</span> <span class="nf">float3</span><span class="p">(</span><span class="kt">Float</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
            <span class="n">pixel</span> <span class="o">=</span> <span class="kt">Pixel</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="nv">green</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="nv">blue</span><span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span>
            <span class="n">pixels</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="o">...</span>
<span class="p">}</span></code></pre></figure>

<p>Notice that we use a variable named <strong>ns</strong> and assign a value of <strong>100</strong> to it so we can sample the color multiple times using randomly generated values as we discussed above. In the main playground page, see the generated new image:</p>

<p><img src="https://github.com/metalkit/images/raw/master/raytracing4.png" alt="alt text" title="Raytracing 4" /></p>

<p>Much better looking! However, we notice our rendering took <strong>7 seconds</strong> which can be reduced by using a smaller sample value, such as <strong>10</strong>. Alright, now that we have multiple rays per pixel, we can finally think of creating <code class="highlighter-rouge">matte</code> (diffuse) materials. This kind of materials do not emit any light and usually absorb all the light that is directed towards them and blend it with their own color. The light that reflects of a diffuse material has its direction randomized. We can compute this with the following function inside <code class="highlighter-rouge">objects.swift</code>:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">random_in_unit_sphere</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">float3</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">p</span> <span class="o">=</span> <span class="nf">float3</span><span class="p">()</span>
    <span class="k">repeat</span> <span class="p">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="kt">Float</span><span class="p">(</span><span class="nf">drand48</span><span class="p">()),</span> <span class="nv">y</span><span class="p">:</span> <span class="kt">Float</span><span class="p">(</span><span class="nf">drand48</span><span class="p">()),</span> <span class="nv">z</span><span class="p">:</span> <span class="kt">Float</span><span class="p">(</span><span class="nf">drand48</span><span class="p">()))</span> <span class="o">-</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">while</span> <span class="nf">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span></code></pre></figure>

<p>Then, back to <code class="highlighter-rouge">ray.swift</code> we need to modify the <code class="highlighter-rouge">color</code> function to factor the new random function into the color calculation:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">color</span><span class="p">(</span><span class="nv">r</span><span class="p">:</span> <span class="n">ray</span><span class="p">,</span> <span class="n">_</span> <span class="nv">world</span><span class="p">:</span> <span class="n">hitable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">float3</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">rec</span> <span class="o">=</span> <span class="nf">hit_record</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">world</span><span class="o">.</span><span class="nf">hit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kt">Float</span><span class="o">.</span><span class="n">infinity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">target</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="n">rec</span><span class="o">.</span><span class="n">normal</span> <span class="o">+</span> <span class="nf">random_in_unit_sphere</span><span class="p">()</span>
        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nf">color</span><span class="p">(</span><span class="nf">ray</span><span class="p">(</span><span class="nv">origin</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="nv">direction</span><span class="p">:</span> <span class="n">target</span> <span class="o">-</span> <span class="n">rec</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="n">world</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">unit_direction</span> <span class="o">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">t</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">unit_direction</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nf">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="nf">float3</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="nv">z</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>In the main playground page, see the generated new image:</p>

<p><img src="https://github.com/metalkit/images/raw/master/raytracing5.png" alt="alt text" title="Raytracing 5" /></p>

<p>If you forgot to decrease <code class="highlighter-rouge">ns</code> from <code class="highlighter-rouge">100</code> to <code class="highlighter-rouge">10</code> your rendering took somewhat around <strong>18 seconds</strong>! However, if you decreased the value, the rendering time is down to only about <strong>1.9 seconds</strong> which is not too shabby for a basic matte surface ray tracer.</p>

<p>This image looks great, however, we can also get rid of those small ripples easily. Notice that inside the <code class="highlighter-rouge">color</code> function we set <code class="highlighter-rouge">Tmin</code> to be <strong>0.0</strong> and this seems to disturb some of the cases where the color needs to be computed correctly. If we set <code class="highlighter-rouge">Tmin</code> to be very small but still positive, something like <strong>0.01</strong>, you will notice that the difference is highly noticeable!</p>

<p><img src="https://github.com/metalkit/images/raw/master/raytracing6.png" alt="alt text" title="Raytracing 6" /></p>

<p>Now, this image looks gorgeous! Stay tuned for the next part of this series, where we will look into topics such as specular lights, transparency, refraction and reflection. The <a href="https://github.com/MetalKit/raytracing">source code</a> is posted on Github as usual.</p>

<p>Until next time!</p>

  </div>

  <!-- 
    

   -->

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style"><br />
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script>
</article>
      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper" align="center">

    <!-- <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p> -->

    <!-- Begin MailChimp Signup Form --><p>
    <link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
    <style type="text/css">
      #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    </style>
    <div id="mc_embed_signup">
      <form action="//github.us12.list-manage.com/subscribe/post?u=5daab344aba23020915a23c29&amp;id=69e4a7c3af" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Subscribe to be notified of new posts.</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
          <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_5daab344aba23020915a23c29_69e4a7c3af" tabindex="-1" value=""></div>
          <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
          </div>
      </form>
    </div>
    </p><!--End mc_embed_signup-->

    <!-- <h2 class="footer-heading">The Metal Framework</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p>
        <ul class="contact-list">
          <li>
            
              The Metal Framework
            
            </li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/MetalKit"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">MetalKit</span></a>

          </li>
          
          
          <li>
            <a href="https://twitter.com/gpu3d"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">gpu3d</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        
          <a href="https://twitter.com/gpu3d"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">gpu3d</span></a>

        
        <p>Resources and tutorials for Metal, MetalKit and Metal Performance Shaders.
</p>
      </div>
    </div> -->

  </div>

</footer>


  </body>

</html>
