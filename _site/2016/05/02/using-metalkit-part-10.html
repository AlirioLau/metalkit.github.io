<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using MetalKit part 10</title>
  <meta name="description" content="Today we will look at the only other type of Metal function we have not used before, the kernel function or compute shader. You will often hear a variation o...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" href="https://devimages.apple.com.edgekey.net/assets/elements/icons/metal/metal-128x128_2x.png" />
  <link rel="canonical" href="http://localhost:4000/2016/05/02/using-metalkit-part-10.html">
  <link rel="alternate" type="application/rss+xml" title="The Metal Framework" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">The Metal Framework</a>

    <nav class="site-nav">
      <a href="/archive.html" style="color:grey;">Archives</a>&nbsp;&nbsp;&nbsp;
      <a href="/contact.html" style="color:grey;">Contact</a>&nbsp;&nbsp;&nbsp;
      <a href="/feed.xml" style="color:grey;">RSS</a>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Using MetalKit part 10</h1>
    <p class="post-meta"><time datetime="2016-05-02T00:00:00-05:00" itemprop="datePublished">May 2, 2016</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href = "https://twitter.com/MTLDevice" target="_blank">Marius Horga</a></span></span></p>
  </header>

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script><br /><br />

  <div class="post-content" itemprop="articleBody">
    <p>Today we will look at the only other type of <code class="highlighter-rouge">Metal function</code> we have not used before, the <strong>kernel function</strong> or <strong>compute shader</strong>. You will often hear a variation of intermixed words from both of them. The kernel is used for <code class="highlighter-rouge">compute</code> tasks, that is, massively parallel computations done on the <code class="highlighter-rouge">GPU</code>. Some examples include: image processing, scientific simulations, and so on. A few important facts to keep in mind about kernels: there is no rendering pipeline, the function always returns <code class="highlighter-rouge">void</code> and its name always starts with the <strong>kernel</strong> keyword, just as the other functions we used before were preceded by the <code class="highlighter-rouge">vertex</code> and <code class="highlighter-rouge">fragment</code> keyword.</p>

<p>Let’s start by stripping down the playground we used in <a href="http://metalkit.org/2016/03/07/using-metalkit-part-8.html">Part 8</a>. First, delete <code class="highlighter-rouge">MathUtils.swift</code> as we will not need it anymore. Then, in <code class="highlighter-rouge">MetalView.swift</code> delete the <code class="highlighter-rouge">createBuffers()</code> function, as well as its call inside the initializer, and the two buffers. Replace the <code class="highlighter-rouge">MTLRenderPipelineState</code> declaration with a <strong>MTLComputePipelineState</strong> declaration. Next, on to the <code class="highlighter-rouge">registerShaders()</code> function. Here are the differences between the old and the new version of it:</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter10_1.png?raw=true" alt="alt text" title="1" /></p>

<p>Notice, we’re not using a <code class="highlighter-rouge">descriptor</code> anymore and instead create our <code class="highlighter-rouge">MTLComputePipelineState</code> with the kernel function directly. Next, let’s see the differences for the <code class="highlighter-rouge">drawRect()</code> function:</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter10_2.png?raw=true" alt="alt text" title="2" /></p>

<p>Notice that the <code class="highlighter-rouge">currentRenderPassDescriptor</code> is not used anymore. The command encoder is created by using the <code class="highlighter-rouge">computeCommandEncoder()</code> function instead. Obviously, we do not need to set the vertex buffers anymore or draw primitives either. Instead, with a kernel function we set a texture to work with, create thread groups and then dispatch them to do work. We use <code class="highlighter-rouge">MTLSize</code> to set the dimensions of each thread group and the number of thread groups that will be executed in each compute call.</p>

<p>Finally, we go the <code class="highlighter-rouge">Shaders.metal</code> file and replace everything inside, with the code below:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="cp">#include &lt;metal_stdlib&gt;
</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">metal</span><span class="p">;</span>

<span class="n">kernel</span> <span class="n">void</span> <span class="nf">compute</span><span class="p">(</span><span class="n">texture2d</span><span class="o">&lt;</span><span class="n">float</span><span class="p">,</span> <span class="nv">access</span><span class="p">::</span><span class="n">write</span><span class="o">&gt;</span> <span class="n">output</span> <span class="p">[[</span><span class="nf">texture</span><span class="p">(</span><span class="mi">0</span><span class="p">)]],</span>
                    <span class="n">uint2</span> <span class="n">gid</span> <span class="p">[[</span><span class="n">thread_position_in_grid</span><span class="p">]])</span>
<span class="p">{</span>
    <span class="n">output</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="nf">float4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">gid</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>We basically just set the same color to every pixel/position in the texture. Now if you go to the home page of the playground and if you are showing the <code class="highlighter-rouge">Timeline</code> in the <code class="highlighter-rouge">Assistant editor</code> you should have a similar view:</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter10_3.png?raw=true" alt="alt text" title="3" /></p>

<p>If you see the output above, you are now ready to proceed. From this point forward, we will not look at the host code (<code class="highlighter-rouge">MetalView.swift</code>) anymore because all our work will be inside the kernel shader.</p>

<p>Alright, let’s start with something simple. Replace the content of the kernel function with the code below:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="nf">get_width</span><span class="p">();</span>
<span class="n">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="nf">get_height</span><span class="p">();</span>
<span class="n">float</span> <span class="n">red</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">gid</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="nf">float</span><span class="p">(</span><span class="n">width</span><span class="p">);</span>
<span class="n">float</span> <span class="n">green</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">gid</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="nf">float</span><span class="p">(</span><span class="n">height</span><span class="p">);</span>
<span class="n">output</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="nf">float4</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">gid</span><span class="p">);</span></code></pre></figure>

<p>As you probably guessed already, we get the <code class="highlighter-rouge">width</code> and <code class="highlighter-rouge">height</code> of the texture, then compute the value of <code class="highlighter-rouge">red</code> and <code class="highlighter-rouge">green</code> based on the pixel position in the texture, and then we write back the new color to the texture. You should see something like this:</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter10_4.png?raw=true" alt="alt text" title="4" /></p>

<p>Next, let’s draw a black circle in the middle of the screen. Replace last line with these lines:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="nf">float2</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span> <span class="o">/</span> <span class="nf">float2</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
<span class="n">uv</span> <span class="o">=</span> <span class="n">uv</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>
<span class="n">bool</span> <span class="n">inside</span> <span class="o">=</span> <span class="nf">length</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">;</span>
<span class="n">output</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="n">inside</span> <span class="p">?</span> <span class="nf">float4</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span> <span class="nf">float4</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">gid</span><span class="p">);</span> </code></pre></figure>

<p>You should see something like this:</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter10_5.png?raw=true" alt="alt text" title="5" /></p>

<p>How exactly did we just do that? Well, this is a common technique used in shading, and is named <strong>distance function</strong>. We use the <code class="highlighter-rouge">length</code> function to determine whether the pixel is within <strong>0.5</strong> distance from the center of the screen which we are just using as the center of the circle as well. Notice that we normalized the <strong>uv</strong> vector to match the range of the window coordinates <strong>[-1, 1]</strong>. Finally, we look whether the pixel is inside and color it <code class="highlighter-rouge">black</code>, or otherwise color it with a gradient, as we did before.</p>

<p>Let’s abstract the inside/outside circle calculation into a useful distance function:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">float</span> <span class="nf">dist</span><span class="p">(</span><span class="n">float2</span> <span class="n">point</span><span class="p">,</span> <span class="n">float2</span> <span class="n">center</span><span class="p">,</span> <span class="n">float</span> <span class="n">radius</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">length</span><span class="p">(</span><span class="n">point</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">-</span> <span class="n">radius</span><span class="p">;</span>
<span class="p">}</span> </code></pre></figure>

<p>Then replace the line where we define <code class="highlighter-rouge">inside</code> with these lines:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">float</span> <span class="n">distToCircle</span> <span class="o">=</span> <span class="nf">dist</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="nf">float2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
<span class="n">bool</span> <span class="n">inside</span> <span class="o">=</span> <span class="n">distToCircle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span></code></pre></figure>

<p>Visually, nothing’s changed, but we now have a function we can easily reuse later on. Next, let’s see how we can modify the background color based on the distance from the circle rather than just the absolute pixel position. We change the value of the alpha channel by calculating the distance from the pixel to the circle. Simply replace the last one with this one:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">output</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="n">inside</span> <span class="p">?</span> <span class="nf">float4</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span> <span class="nf">float4</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">distToCircle</span><span class="p">),</span> <span class="n">gid</span><span class="p">);</span></code></pre></figure>

<p>You should see something like this:</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter10_6.png?raw=true" alt="alt text" title="6" /></p>

<p>Beautiful, right? Now that we just got this idea of a total eclipse of the Sun, let’s make it look more realistic. We need one more circle (the Sun) and we want to move the initial circle a bit to the left and a little lower so they are both visible. Replace the line where we define <code class="highlighter-rouge">inside</code> with these ones:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">float</span> <span class="n">distToCircle2</span> <span class="o">=</span> <span class="nf">dist</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="nf">float2</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
<span class="n">bool</span> <span class="n">inside</span> <span class="o">=</span> <span class="n">distToCircle2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span></code></pre></figure>

<p>You should see something like this:</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter10_7.png?raw=true" alt="alt text" title="7" /></p>

<p>We are just beginning to scratch the surface of shading techniques. In the next episode we will look into more complex and dynamic compute tasks. Special thanks to <a href="https://twitter.com/_psonice">Chris Wood</a> for his valuable advising. The <a href="https://github.com/MetalKit/metal">source code</a> is posted on Github as usual.</p>

<p>Until next time!</p>

  </div>

  <!-- 
    

   -->

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style"><br />
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script>
</article>
      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper" align="center">

    <!-- <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p> -->

    <!-- Begin MailChimp Signup Form --><p>
    <link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
    <style type="text/css">
      #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    </style>
    <div id="mc_embed_signup">
      <form action="//github.us12.list-manage.com/subscribe/post?u=5daab344aba23020915a23c29&amp;id=69e4a7c3af" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Subscribe to be notified of new posts.</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
          <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_5daab344aba23020915a23c29_69e4a7c3af" tabindex="-1" value=""></div>
          <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
          </div>
      </form>
    </div>
    </p><!--End mc_embed_signup-->

    <!-- <h2 class="footer-heading">The Metal Framework</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p>
        <ul class="contact-list">
          <li>
            
              The Metal Framework
            
            </li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/MetalKit"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">MetalKit</span></a>

          </li>
          
          
          <li>
            <a href="https://twitter.com/gpu3d"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">gpu3d</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        
          <a href="https://twitter.com/gpu3d"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">gpu3d</span></a>

        
        <p>Resources and tutorials for Metal, MetalKit and Metal Performance Shaders.
</p>
      </div>
    </div> -->

  </div>

</footer>


  </body>

</html>
