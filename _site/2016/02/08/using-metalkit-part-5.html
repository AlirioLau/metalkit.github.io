<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using MetalKit part 5</title>
  <meta name="description" content="Last time we described the graphics pipeline and the Metal pipeline. It is time we looked deeper inside the pipeline, and understand how vertices are really ...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" href="https://devimages.apple.com.edgekey.net/assets/elements/icons/metal/metal-128x128_2x.png" />
  <link rel="canonical" href="http://localhost:4000/2016/02/08/using-metalkit-part-5.html">
  <link rel="alternate" type="application/rss+xml" title="The Metal Framework" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">The Metal Framework</a>

    <nav class="site-nav">
      <a href="/archive.html">Archive</a>&nbsp;&nbsp;&nbsp;
      <a href="/contact.html">Contact</a>&nbsp;&nbsp;&nbsp;
      <a href="/feed.xml">RSS</a>

      <!-- <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>

      <div class="trigger">
        
          
          <a class="page-link" href="/archive.html">Archive</a>
          
        
          
          <a class="page-link" href="/contact.html">Send me a message</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div> -->
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Using MetalKit part 5</h1>
    <p class="post-meta"><time datetime="2016-02-08T00:00:00+02:00" itemprop="datePublished">Feb 8, 2016</time></p>
  </header>

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script><br /><br />

  <div class="post-content" itemprop="articleBody">
    <p>Last time we described the <code class="highlighter-rouge">graphics pipeline</code> and the <code class="highlighter-rouge">Metal pipeline</code>. It is time we looked deeper inside the pipeline, and understand how vertices are really processed at a lower level. For this, we need to learn a few <code class="highlighter-rouge">3D math</code> concepts such as <strong>transformations</strong>.</p>

<p>In the world of <code class="highlighter-rouge">3D graphics</code> we often think in terms of <strong>3</strong> or <strong>4</strong> dimensions for our data. As you remember from our previous episodes, <code class="highlighter-rouge">location</code> and <code class="highlighter-rouge">color</code> were both of type <strong>vector_float4</strong> (4-dimensional). In order to draw 3D geometry on the screen, vertices suffer a series of transformations - from <code class="highlighter-rouge">object space</code> to <code class="highlighter-rouge">world space</code>, then to <code class="highlighter-rouge">camera/eye space</code>, then to <code class="highlighter-rouge">clipping space</code>, then to <code class="highlighter-rouge">normalized device coordinates</code> space, and finally to <code class="highlighter-rouge">screen space</code>. We are only looking at the first stage in this episode.</p>

<p>The vertices of our <code class="highlighter-rouge">triangle</code> are expressed in terms of an <code class="highlighter-rouge">object space</code> (local coordinates). They are currently specified about the triangle’s origin which lies at the center of the screen. In order to position and move the triangle in a larger scene (world space), we need to apply <code class="highlighter-rouge">transformations</code> to these vertices. The <code class="highlighter-rouge">transformations</code> we will look at are: <strong>scaling</strong>, <strong>translation</strong> and <strong>rotation</strong>.</p>

<p>The <strong>translation matrix</strong> is similar to an <strong>identity matrix</strong> (with values of <strong>1</strong> on its main diagonal) and where positions <strong>[12]</strong>, <strong>[13]</strong> and <strong>[14]</strong> (in <code class="highlighter-rouge">column-major order</code> they are the equivalent of the <code class="highlighter-rouge">[3]</code>, <code class="highlighter-rouge">[7]</code> and <code class="highlighter-rouge">[11]</code> positions) are populated with the values of a <strong>D</strong> vector representing the <strong>distance</strong> the vertex would be moved to, on the respective <strong>x</strong>, <strong>y</strong>, <strong>z</strong> axes.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="o">|</span> <span class="mi">1</span>     <span class="mi">0</span>     <span class="mi">0</span>    <span class="kt">Dx</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="mi">1</span>     <span class="mi">0</span>    <span class="kt">Dy</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">1</span>    <span class="kt">Dz</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">1</span> <span class="o">|</span></code></pre></figure>

<p>The <strong>scaling matrix</strong> is also similar to an <strong>identity matrix</strong> where positions <strong>[0]</strong>, <strong>[5]</strong> and <strong>[10]</strong> are populated with the values of a <strong>S</strong> vector representing the <strong>scale</strong> the vertex would be zoomed in/out to. The <strong>x</strong>, <strong>y</strong>, <strong>z</strong> vector values are usually the same <strong>float</strong> value since scaling is done proportionally on all axes.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="o">|</span> <span class="kt">Sx</span>    <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="kt">Sy</span>    <span class="mi">0</span>     <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="mi">0</span>     <span class="kt">Sz</span>    <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">1</span> <span class="o">|</span></code></pre></figure>

<p>The <strong>rotation matrix</strong> is also similar to an <strong>identity matrix</strong> where depending on which axis we are rotating about, different positions are being populated with either the <strong>sinus</strong> or <strong>cosinus</strong> of the <strong>angle</strong> we are rotating with. If we are rotating about the <strong>x</strong> axis, positions <strong>[5]</strong>, <strong>[6]</strong>, <strong>[9]</strong> and <strong>[10]</strong> are populated. If we are rotating about the <strong>y</strong> axis, positions <strong>[0]</strong>, <strong>[2]</strong>, <strong>[8]</strong> and <strong>[10]</strong> are populated. Finally, if we are rotating about the <strong>z</strong> axis, positions <strong>[0]</strong>, <strong>[1]</strong>, <strong>[4]</strong> and <strong>[5]</strong> are populated. Remember, these positions need to be transposed into <code class="highlighter-rouge">column-major order</code>.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="o">|</span> <span class="mi">1</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>    <span class="n">cos</span>  <span class="o">-</span><span class="n">sin</span>    <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>    <span class="n">sin</span>   <span class="n">cos</span>    <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">1</span> <span class="o">|</span>

<span class="o">|</span> <span class="n">cos</span>   <span class="mi">0</span>    <span class="n">sin</span>    <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="mi">1</span>     <span class="mi">0</span>     <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">-</span><span class="n">sin</span>  <span class="mi">0</span>    <span class="n">cos</span>    <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">1</span> <span class="o">|</span>

<span class="o">|</span> <span class="n">cos</span>  <span class="o">-</span><span class="n">sin</span>   <span class="mi">0</span>     <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">sin</span>  <span class="n">cos</span>    <span class="mi">0</span>     <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">1</span>     <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">1</span> <span class="o">|</span></code></pre></figure>

<p>Alright, we had enough math for a whole week, so let’s put these matrices into code. We will continue with the code from where we left off after <a href="https://github.com/MetalKit/metal">part 3</a>. It comes in handy for us to create a <code class="highlighter-rouge">struct</code> named <strong>Matrix</strong> that will include these <code class="highlighter-rouge">transformations</code>:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="kd">struct</span> <span class="kt">Matrix</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">m</span><span class="p">:</span> <span class="p">[</span><span class="kt">Float</span><span class="p">]</span>
    
    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">]</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">translationMatrix</span><span class="p">(</span><span class="k">var</span> <span class="nv">matrix</span><span class="p">:</span> <span class="kt">Matrix</span><span class="p">,</span> <span class="n">_</span> <span class="nv">position</span><span class="p">:</span> <span class="n">float3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Matrix</span> <span class="p">{</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">x</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">y</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">z</span>
        <span class="k">return</span> <span class="n">matrix</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">scalingMatrix</span><span class="p">(</span><span class="k">var</span> <span class="nv">matrix</span><span class="p">:</span> <span class="kt">Matrix</span><span class="p">,</span> <span class="n">_</span> <span class="nv">scale</span><span class="p">:</span> <span class="kt">Float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Matrix</span> <span class="p">{</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">matrix</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">rotationMatrix</span><span class="p">(</span><span class="k">var</span> <span class="nv">matrix</span><span class="p">:</span> <span class="kt">Matrix</span><span class="p">,</span> <span class="n">_</span> <span class="nv">rot</span><span class="p">:</span> <span class="n">float3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Matrix</span> <span class="p">{</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nf">cos</span><span class="p">(</span><span class="n">rot</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">matrix</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">modelMatrix</span><span class="p">(</span><span class="k">var</span> <span class="nv">matrix</span><span class="p">:</span> <span class="kt">Matrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Matrix</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">matrix</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Let’s walk over this code. We first create the <code class="highlighter-rouge">struct</code> and declare an <code class="highlighter-rouge">array</code> of <code class="highlighter-rouge">floats</code>. Then we provide an initializer for it, which is the <strong>identity matrix</strong> (all <strong>1’s</strong> on the diagonal). Next, we create the transformation matrices. Finally, we create a <strong>modelMatrix</strong> which will combine all the transformations into a single output matrix.</p>

<p>In order to have these transformation work, we need to send them to the <code class="highlighter-rouge">GPU</code> via a <code class="highlighter-rouge">shader</code>. In order to do that we first need to create a new buffer. Let’s name it <strong>uniform_buffer</strong>. <code class="highlighter-rouge">Uniforms</code> are constructs we can use when we want to send data the applies to the entire model rather than to each vertex. It only makes sense that we save space by using <code class="highlighter-rouge">uniforms</code> instead and sending one final <code class="highlighter-rouge">model matrix</code> containing all the transformations. So at the very beginning of our <code class="highlighter-rouge">MetalView</code> class, create the new buffer:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="k">var</span> <span class="nv">uniform_buffer</span><span class="p">:</span> <span class="kt">MTLBuffer</span><span class="o">!</span></code></pre></figure>

<p>Inside the <strong>createBuffers()</strong> function, allocate memory for the buffer, enough to hold a <strong>4x4</strong> matrix:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="n">uniform_buffer</span> <span class="o">=</span> <span class="n">device</span><span class="o">!.</span><span class="nf">newBufferWithLength</span><span class="p">(</span><span class="nf">sizeof</span><span class="p">(</span><span class="kt">Float</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[])</span>
<span class="k">let</span> <span class="nv">bufferPointer</span> <span class="o">=</span> <span class="n">uniform_buffer</span><span class="o">.</span><span class="nf">contents</span><span class="p">()</span>
<span class="nf">memcpy</span><span class="p">(</span><span class="n">bufferPointer</span><span class="p">,</span> <span class="kt">Matrix</span><span class="p">()</span><span class="o">.</span><span class="nf">modelMatrix</span><span class="p">(</span><span class="kt">Matrix</span><span class="p">())</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="nf">sizeof</span><span class="p">(</span><span class="kt">Float</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span></code></pre></figure>

<p>Inside the <strong>sendToGPU()</strong> function, after setting the <code class="highlighter-rouge">vertex_buffer</code> in the <code class="highlighter-rouge">command encoder</code>, also set the <strong>uniform_buffer</strong>:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="n">command_encoder</span><span class="o">.</span><span class="nf">setVertexBuffer</span><span class="p">(</span><span class="n">uniform_buffer</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">atIndex</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span></code></pre></figure>

<p>Finally, let’s move to <strong>Shaders.metal</strong> for the last part of the configuration. Below the <code class="highlighter-rouge">Vertex</code> struct, create a new struct named <strong>Uniforms</strong> that will hold our model matrix:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="kd">struct</span> <span class="kt">Uniforms</span> <span class="p">{</span>
    <span class="n">float4x4</span> <span class="n">modelMatrix</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure>

<p>Modify the <code class="highlighter-rouge">vertex shader</code> to include the transformations we passed along from the <code class="highlighter-rouge">CPU</code>:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="n">vertex</span> <span class="kt">Vertex</span> <span class="nf">vertex_func</span><span class="p">(</span><span class="n">constant</span> <span class="kt">Vertex</span> <span class="o">*</span><span class="n">vertices</span> <span class="p">[[</span><span class="nf">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)]],</span>
                          <span class="n">constant</span> <span class="kt">Uniforms</span> <span class="o">&amp;</span><span class="n">uniforms</span> <span class="p">[[</span><span class="nf">buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)]],</span>
                          <span class="n">uint</span> <span class="n">vid</span> <span class="p">[[</span><span class="n">vertex_id</span><span class="p">]])</span>
<span class="p">{</span>
    <span class="n">float4x4</span> <span class="n">matrix</span> <span class="o">=</span> <span class="n">uniforms</span><span class="o">.</span><span class="n">modelMatrix</span><span class="p">;</span>
    <span class="kt">Vertex</span> <span class="k">in</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">vid</span><span class="p">];</span>
    <span class="kt">Vertex</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">out</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="nf">float4</span><span class="p">(</span><span class="k">in</span><span class="o">.</span><span class="n">position</span><span class="p">);</span>
    <span class="n">out</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="k">in</span><span class="o">.</span><span class="n">color</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>All we did here was to pass <strong>uniforms</strong> as the <strong>2nd</strong> argument (buffer), and then multiply the model matrix with the vertices. If you run the app now, you will see our good old triangle friend, taking the entire space of the view.</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter05_1.png?raw=true" alt="alt text" title="1" /></p>

<p>Let’s <strong>scale</strong> it down to a quarter of its original size. Add this line to the <strong>modelMatrix</strong> function:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="n">matrix</span> <span class="o">=</span> <span class="nf">scalingMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span></code></pre></figure>

<p>Run the app again and notice that the triangle is way smaller now:</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter05_2.png?raw=true" alt="alt text" title="2" /></p>

<p>Next, let’s <strong>translate</strong> the triangle up on the <strong>y</strong> axis by moving it up half the screen size:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="n">matrix</span> <span class="o">=</span> <span class="nf">translationMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="nf">float3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span></code></pre></figure>

<p>Run the app again and notice that the triangle is now higher than before:</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter05_3.png?raw=true" alt="alt text" title="3" /></p>

<p>Finally, let’s <strong>rotate</strong> the triangle about the <strong>z</strong> axis:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"> 
<span class="n">matrix</span> <span class="o">=</span> <span class="nf">rotationMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="nf">float3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span></code></pre></figure>

<p>Run the app again and notice that the triangle is now also rotated:</p>

<p><img src="https://github.com/MetalKit/images/blob/master/chapter05_4.png?raw=true" alt="alt text" title="4" /></p>

<p>Next week we will finally get to drawing 3D objects (such as cubes or spheres). The <a href="https://github.com/MetalKit/metal">source code</a> is posted on Github as usual.</p>

<p>Until next time!</p>

  </div>

  
    

  

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style"><br />
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script>
</article>
      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper" align="center">

    <!-- <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p> -->

    <!-- Begin MailChimp Signup Form --><p>
    <link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
    <style type="text/css">
      #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    </style>
    <div id="mc_embed_signup">
      <form action="//github.us12.list-manage.com/subscribe/post?u=5daab344aba23020915a23c29&amp;id=69e4a7c3af" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Subscribe to be notified of new posts.</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
          <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_5daab344aba23020915a23c29_69e4a7c3af" tabindex="-1" value=""></div>
          <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
          </div>
      </form>
    </div>
    </p><!--End mc_embed_signup-->

    <!-- <h2 class="footer-heading">The Metal Framework</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p>
        <ul class="contact-list">
          <li>
            
              The Metal Framework
            
            </li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/MetalKit"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">MetalKit</span></a>

          </li>
          
          
          <li>
            <a href="https://twitter.com/MTLDevice"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">MTLDevice</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        
          <a href="https://twitter.com/MTLDevice"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">MTLDevice</span></a>

        
        <p>Resources and tutorials for Metal, MetalKit and Metal Performance Shaders.
</p>
      </div>
    </div> -->

  </div>

</footer>


  </body>

</html>
