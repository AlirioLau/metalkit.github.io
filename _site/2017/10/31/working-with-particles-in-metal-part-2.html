<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Working with Particles in Metal part 2</title>
  <meta name="description" content="Last time we looked at how to quickly prototype a particle-like object directly inside a shader, using distance functions. That was acceptable for moving an ...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/MetalKit/images/master/metal_ico.png" />
  <link rel="canonical" href="http://localhost:4000/2017/10/31/working-with-particles-in-metal-part-2.html">
  <link rel="alternate" type="application/rss+xml" title="The Metal Framework" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">The Metal Framework</a>

    <nav class="site-nav">
    
    <!--
      <a href="/archive.html" style="color:grey;">Archives</a>&nbsp;&nbsp;&nbsp;
    -->
    
      <a href="/contact.html" style="color:grey;">Contact</a>&nbsp;&nbsp;&nbsp;
      <a href="/feed.xml" style="color:grey;">RSS</a>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Working with Particles in Metal part 2</h1>
    <p class="post-meta"><time datetime="2017-10-31T00:00:00-05:00" itemprop="datePublished">Oct 31, 2017</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href = "https://twitter.com/gpu3d" target="_blank">Marius Horga</a></span></span></p>
  </header>

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script><br /><br />

  <div class="post-content" itemprop="articleBody">
    <p>Last time we looked at how to quickly prototype a particle-like object directly inside a shader, using distance functions. That was acceptable for moving an object based on time elapsed. However, if we want to work with vertices we would need to define the particles on the <code class="highlighter-rouge">CPU</code> and send the vertex data to the <code class="highlighter-rouge">GPU</code>. We use again a minimal playground we used in the past for <code class="highlighter-rouge">3D</code> rendering, and we start by creating a <strong>Particle</strong> struct in our metal view delegate class:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Particle</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">initialMatrix</span> <span class="o">=</span> <span class="n">matrix_identity_float4x4</span>
    <span class="k">var</span> <span class="nv">matrix</span> <span class="o">=</span> <span class="n">matrix_identity_float4x4</span>
    <span class="k">var</span> <span class="nv">color</span> <span class="o">=</span> <span class="nf">float4</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, we create an array of particles and a buffer to hold the data. Here we also give each particle a nice blue color and a random position to start at:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">particles</span> <span class="o">=</span> <span class="p">[</span><span class="kt">Particle</span><span class="p">](</span><span class="nf">repeatElement</span><span class="p">(</span><span class="kt">Particle</span><span class="p">(),</span> <span class="nv">count</span><span class="p">:</span> <span class="mi">1000</span><span class="p">))</span>
<span class="n">particlesBuffer</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="nf">makeBuffer</span><span class="p">(</span><span class="nv">length</span><span class="p">:</span> <span class="n">particles</span><span class="o">.</span><span class="n">count</span> <span class="o">*</span> <span class="kt">MemoryLayout</span><span class="o">&lt;</span><span class="kt">Particle</span><span class="o">&gt;.</span><span class="n">stride</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[])</span><span class="o">!</span>
<span class="k">var</span> <span class="nv">pointer</span> <span class="o">=</span> <span class="n">particlesBuffer</span><span class="o">.</span><span class="nf">contents</span><span class="p">()</span><span class="o">.</span><span class="nf">bindMemory</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="kt">Particle</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">capacity</span><span class="p">:</span> <span class="n">particles</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="n">particles</span> <span class="p">{</span>
    <span class="n">pointer</span><span class="o">.</span><span class="n">pointee</span><span class="o">.</span><span class="n">initialMatrix</span> <span class="o">=</span> <span class="nf">translate</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="p">[</span><span class="kt">Float</span><span class="p">(</span><span class="nf">drand48</span><span class="p">())</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="kt">Float</span><span class="p">(</span><span class="nf">drand48</span><span class="p">())</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">pointer</span><span class="o">.</span><span class="n">pointee</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="nf">float4</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pointer</span> <span class="o">=</span> <span class="n">pointer</span><span class="o">.</span><span class="nf">advanced</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Note: we divide the <code class="highlighter-rouge">x</code> coordinate by <code class="highlighter-rouge">10</code> to gather particles inside a small horizontal range, while we multiply the <code class="highlighter-rouge">y</code> coordinate by <code class="highlighter-rouge">10</code> for the opposite effect - to spread out the particles vertically a little.</p>
</blockquote>

<p>The next step is to create a sphere that will serve as the particle’s mesh:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">allocator</span> <span class="o">=</span> <span class="kt">MTKMeshBufferAllocator</span><span class="p">(</span><span class="nv">device</span><span class="p">:</span> <span class="n">device</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">sphere</span> <span class="o">=</span> <span class="kt">MDLMesh</span><span class="p">(</span><span class="nv">sphereWithExtent</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span> <span class="nv">segments</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="nv">inwardNormals</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nv">geometryType</span><span class="p">:</span> <span class="o">.</span><span class="n">triangles</span><span class="p">,</span> <span class="nv">allocator</span><span class="p">:</span> <span class="n">allocator</span><span class="p">)</span>
<span class="k">do</span> <span class="p">{</span> <span class="n">model</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">MTKMesh</span><span class="p">(</span><span class="nv">mesh</span><span class="p">:</span> <span class="n">sphere</span><span class="p">,</span> <span class="nv">device</span><span class="p">:</span> <span class="n">device</span><span class="p">)</span> <span class="p">}</span> 
<span class="k">catch</span> <span class="k">let</span> <span class="nv">e</span> <span class="p">{</span> <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<p>Next, we need an updating function to animate the particles on the screen. Inside, we increase the timer each frame by <code class="highlighter-rouge">0.01</code> and update the <code class="highlighter-rouge">y</code> coordinate using the timer value - creating a falling-like motion:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">update</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">timer</span> <span class="o">+=</span> <span class="mf">0.01</span>
    <span class="k">var</span> <span class="nv">pointer</span> <span class="o">=</span> <span class="n">particlesBuffer</span><span class="o">.</span><span class="nf">contents</span><span class="p">()</span><span class="o">.</span><span class="nf">bindMemory</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="kt">Particle</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">capacity</span><span class="p">:</span> <span class="n">particles</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="n">particles</span> <span class="p">{</span>
        <span class="n">pointer</span><span class="o">.</span><span class="n">pointee</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="nf">translate</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">pointer</span><span class="o">.</span><span class="n">pointee</span><span class="o">.</span><span class="n">initialMatrix</span>
        <span class="n">pointer</span> <span class="o">=</span> <span class="n">pointer</span><span class="o">.</span><span class="nf">advanced</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At this point we are ready to call this function inside the <strong>draw</strong> method and then send the data to the <code class="highlighter-rouge">GPU</code>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">update</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">submesh</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">submeshes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">commandEncoder</span><span class="o">.</span><span class="nf">setVertexBuffer</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">vertexBuffers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">index</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">commandEncoder</span><span class="o">.</span><span class="nf">setVertexBuffer</span><span class="p">(</span><span class="n">particlesBuffer</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">index</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">commandEncoder</span><span class="o">.</span><span class="nf">drawIndexedPrimitives</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="o">.</span><span class="n">triangle</span><span class="p">,</span> <span class="nv">indexCount</span><span class="p">:</span> <span class="n">submesh</span><span class="o">.</span><span class="n">indexCount</span><span class="p">,</span> <span class="nv">indexType</span><span class="p">:</span> <span class="n">submesh</span><span class="o">.</span><span class="n">indexType</span><span class="p">,</span> <span class="nv">indexBuffer</span><span class="p">:</span> <span class="n">submesh</span><span class="o">.</span><span class="n">indexBuffer</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="nv">indexBufferOffset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">instanceCount</span><span class="p">:</span> <span class="n">particles</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
</code></pre></div></div>

<p>In the <strong>Shaders.metal</strong> file we have a struct for the incoming and outgoing vertices, as well as one for the particle instances:</p>

<pre><code class="language-clike">struct VertexIn {
    float4 position [[attribute(0)]];
};

struct VertexOut {
    float4 position [[position]];
    float4 color;
};

struct Particle {
    float4x4 initial_matrix;
    float4x4 matrix;
    float4 color;
};
</code></pre>

<p>The vertex shader uses the <strong>instance_id</strong> attribute which we use to create many instances of the same one sphere we sent to the <code class="highlighter-rouge">GPU</code> in the vertex buffer at index <code class="highlighter-rouge">0</code>. We then assign to each instance one of the positions we stored and sent to the <code class="highlighter-rouge">GPU</code> in the buffer at index <code class="highlighter-rouge">1</code>.</p>

<pre><code class="language-clike">vertex VertexOut vertex_main(const VertexIn vertex_in [[stage_in]],
                             constant Particle *particles [[buffer(1)]],
                             uint instanceid [[instance_id]]) {
    VertexOut vertex_out;
    Particle particle = particles[instanceid];
    vertex_out.position = particle.matrix * vertex_in.position ;
    vertex_out.color = particle.color;
    return vertex_out;
}
</code></pre>

<p>Finally, in the fragment shader we return the color we passed through in the vertex shader:</p>

<pre><code class="language-clike">fragment float4 fragment_main(VertexOut vertex_in [[stage_in]]) {
    return vertex_in.color;
}
</code></pre>

<p>If you run the app, you should be able to see the particles falling down like a water stream:</p>

<p>￼￼<img src="https://github.com/MetalKit/images/blob/master/particles.gif?raw=true" alt="alt text" title="Particle" /></p>

<p>There is yet another, much more efficient approach to rendering particles on the <code class="highlighter-rouge">GPU</code>. We’ll look into that next time. I want to thank <a href="https://twitter.com/carolinebegbie">Caroline</a> for her valuable assistance with instancing. The <a href="https://github.com/MetalKit/metal">source code</a> is posted on <code class="highlighter-rouge">Github</code> as usual.</p>

<p>Until next time!</p>

  </div>

  <!-- 
    

   -->

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style"><br />
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script>
</article>
      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper" align="center">

    <!-- <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p> -->

    <!-- Begin MailChimp Signup Form --><p>
    <link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
    <style type="text/css">
      #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    </style>
    <div id="mc_embed_signup">
      <form action="//github.us12.list-manage.com/subscribe/post?u=5daab344aba23020915a23c29&amp;id=69e4a7c3af" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Subscribe to be notified of new posts.</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
          <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_5daab344aba23020915a23c29_69e4a7c3af" tabindex="-1" value=""></div>
          <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
          </div>
      </form>
    </div>
    </p><!--End mc_embed_signup-->

    <!-- <h2 class="footer-heading">The Metal Framework</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p>
        <ul class="contact-list">
          <li>
            
              The Metal Framework
            
            </li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/MetalKit"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">MetalKit</span></a>

          </li>
          
          
          <li>
            <a href="https://twitter.com/gpu3d"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">gpu3d</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        
          <a href="https://twitter.com/gpu3d"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">gpu3d</span></a>

        
        <p>Resources and tutorials for Metal, MetalKit and Metal Performance Shaders.
</p>
      </div>
    </div> -->

  </div>

</footer>


  </body>

</html>
