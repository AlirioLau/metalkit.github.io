<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using eGPUs with Metal</title>
  <meta name="description" content="For those (like me) who need raw GPU power but only possess a laptop and do not want to buy a beefy desktop machine, the solution seems to be an external GPU...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/MetalKit/images/master/metal_ico.png" />
  <link rel="canonical" href="http://localhost:4000/2018/11/30/using-egpus-with-metal.html">
  <link rel="alternate" type="application/rss+xml" title="The Metal Framework" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">The Metal Framework</a>

    <nav class="site-nav">
    
    <!--
      <a href="/archive.html" style="color:grey;">Archives</a>&nbsp;&nbsp;&nbsp;
    -->
    
      <a href="/contact.html" style="color:grey;">Contact</a>&nbsp;&nbsp;&nbsp;
      <a href="/feed.xml" style="color:grey;">RSS</a>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Using eGPUs with Metal</h1>
    <p class="post-meta"><time datetime="2018-11-30T00:00:00-06:00" itemprop="datePublished">Nov 30, 2018</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href = "https://twitter.com/gpu3d" target="_blank">Marius Horga</a></span></span></p>
  </header>

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script><br /><br />

  <div class="post-content" itemprop="articleBody">
    <p>For those (like me) who need raw GPU power but only possess a laptop and do not want to buy a beefy desktop machine, the solution seems to be an external GPU (eGPU). While Nvidia eGPUs are not supported by macOS at the moment, there are plenty of GPU options from AMD.</p>

<p>In looking for the perfect GPU, I stopped at none other than the <a href="https://www.techpowerup.com/gpu-specs/radeon-rx-vega-64.c2871">AMD Radeon RX Vega 64</a> which is the high end GPU they offer currently and the 2nd most performant among all GPUs on the consumer market. It is topped only by one Nvidia GPU in terms of TFLOPS performance.</p>

<p>A teraflops (TFLOPS) chip is able to run one trillion floating-point operations per second. TFLOPS is a key performance metric in scientific computing, machine learning and any other areas that need compute-intensive work.</p>

<p>The AMD Radeon RX Vega 64 has 4096 cores able to provide 12 TFLOPS (single precision) and sits conveniently right in between the <a href="https://www.techpowerup.com/gpu-specs/geforce-gtx-1080-ti.c2877">Nvidia Geforce GTX 1080 ti</a> with 3584 cores (11 TFLOPS) and the new <a href="https://www.techpowerup.com/gpu-specs/geforce-rtx-2080-ti.c3305">Nvidia Geforce RTX 2080 ti</a> with 4352 cores (13 TFLOPS).</p>

<p>Of course, eGPUs are also accelerating graphics applications and games, lets you connect additional monitors and VR headsets. Keep in mind that eGPUs only work with Thunderbolt 3-equipped Macs running macOS High Sierra 10.13.4 or later. For more informations about compatibility read the <a href="https://support.apple.com/en-us/HT208544">Use an external graphics processor with your Mac</a> webpage.</p>

<p>I went ahead and purchased a Razer Core X enclosure because for Vega 64 it is recommended to have a power source of at least 600W and there aren’t many such boxes available. The <a href="https://www.sonnetstore.com/collections/egpu-expansion-systems/products/egfx-breakaway-box-650">Sonnet eGFX Breakaway box 650</a> is lighter but more expensive. Razer Core X is as wide and tall as a 15” Macbook Pro as you can see below:</p>

<p><span style="display:block;text-align:center"><img src="https://raw.githubusercontent.com/MetalKit/images/master/razer.jpg?raw=true" alt="alt text" title="Razer" /></span></p>

<p>Those 650W are not used entirely by the GPU, by the way. Vega 64 requires only 295W actually. The additional power is available for cases when you overclock your GPU so that it runs even faster, but not only for that - you get to also charge your Mac via the Thunderbolt 3 cable so you do not need the Mac charger anymore while connected to the eGPU. Also, make no mistake, the Vega 64 is almost as wide and heavy as the enclosure - a real monster!</p>

<p><span style="display:block;text-align:center"><img src="https://raw.githubusercontent.com/MetalKit/images/master/vega64.png?raw=true" alt="alt text" title="Vega 64" /></span></p>

<p>As soon as you connect the eGPU to your Mac via a Thunderbolt 3 cable and power up the enclosure, you will notice the new eGPU icon in the menu bar:</p>

<p><span style="display:block;text-align:center"><img src="https://raw.githubusercontent.com/MetalKit/images/master/plugged_in.png?raw=true" alt="alt text" title="Plugged In" /></span></p>

<p>In the Activity Monitor if you open the GPU History view you will see all your GPUs listed - integrated, discrete or external:</p>

<p><span style="display:block;text-align:center"><img src="https://raw.githubusercontent.com/MetalKit/images/master/activity_monitor.png?raw=true" alt="alt text" title="Activity Monitor" /></span></p>

<p>In the System Information app, under Graphics/Displays, you will see all your GPUs listed as well, along with some basic information:</p>

<p><span style="display:block;text-align:center"><img src="https://raw.githubusercontent.com/MetalKit/images/master/system_information.png?raw=true" alt="alt text" title="System Information" /></span></p>

<p>If you right click on a game or application that needs a GPU and click Get Info, you will notice the “Prefer external GPU” option:</p>

<p><span style="display:block;text-align:center"><img src="https://raw.githubusercontent.com/MetalKit/images/master/prefer.png?raw=true" alt="alt text" title="Prefer external GPU" /></span></p>

<p>I installed Geekbench 4 so I can run a few benchmarks. The trial version lets you run benchmarks and store results online only and it only lets you run the OpenCL tests. The full version allows for Dropbox integration, saving the results locally and running Metal tests as well.</p>

<p><span style="display:block;text-align:center"><img src="https://raw.githubusercontent.com/MetalKit/images/master/geekbench.png?raw=true" alt="alt text" title="Geekbench" /></span></p>

<p>Running a test only takes a minute to complete:</p>

<p><span style="display:block;text-align:center"><img src="https://raw.githubusercontent.com/MetalKit/images/master/geekbench_metal.png?raw=true" alt="alt text" title="Geekbench Metal" /></span></p>

<p>As expected, the biggest score was obtained for a Metal test running on Vega 64. I had the following scores in decreasing order of scores:</p>

<p>– Metal on Radeon RX Vega 64 – 137651 <br />
– OpenCL on Radeon RX Vega 64 – 135711 <br />
– Metal on Radeon Pro 450 - 41602 <br />
– OpenCL on Radeon Pro 450 - 41578 <br />
– Metal on Intel HD 530 – 21888 <br />
– OpenCL on Intel HD 530 – 20878 <br />
– OpenCL on quad-core CPU - 13867</p>

<p>The next obvious step is to run some Metal code on these GPUs. Finally! In a playground add this code snippet:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Metal</span>

<span class="k">let</span> <span class="nv">devices</span> <span class="o">=</span> <span class="kt">MTLCopyAllDevices</span><span class="p">()</span>

<span class="k">for</span> <span class="n">device</span> <span class="k">in</span> <span class="n">devices</span> <span class="p">{</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Is device low power? </span><span class="se">\(</span><span class="n">device</span><span class="o">.</span><span class="n">isLowPower</span><span class="se">)</span><span class="s">."</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Is device external? </span><span class="se">\(</span><span class="n">device</span><span class="o">.</span><span class="n">isRemovable</span><span class="se">)</span><span class="s">."</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Maximum threads per group: </span><span class="se">\(</span><span class="n">device</span><span class="o">.</span><span class="n">maxThreadsPerThreadgroup</span><span class="se">)</span><span class="s">."</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Maximum buffer length: </span><span class="se">\(</span><span class="kt">Float</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">maxBufferLength</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="se">)</span><span class="s"> GB."</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Run the playground and see a similar output:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AMD Radeon RX Vega 64
Is device low power? false.
Is device external? true.
Maximum threads per group: MTLSize(width: 1024, height: 1024, depth: 1024).
Maximum buffer length: 4.5 GB.

AMD Radeon Pro 450
Is device low power? false.
Is device external? false.
Maximum threads per group: MTLSize(width: 1024, height: 1024, depth: 1024).
Maximum buffer length: 1.5 GB.

Intel(R) HD Graphics 530
Is device low power? true.
Is device external? false.
Maximum threads per group: MTLSize(width: 256, height: 256, depth: 256).
Maximum buffer length: 2.0 GB.
</code></pre></div></div>

<p>You can query your devices for many more attributes and features such as memory availability, programmable sample positions support, raster order groups support and so on. For more information, see the <a href="https://developer.apple.com/documentation/metal/mtldevice">MTLDevice</a> webpage.</p>

<p>Apple provides two sample code projects to help you with GPU management in both rendering and compute pipelines:</p>

<ul>
  <li><a href="https://developer.apple.com/documentation/metal/choosing_gpus_on_mac/device_selection_and_fallback_for_graphics_rendering">Device Selection and Fallback for Graphics Rendering</a></li>
  <li><a href="https://developer.apple.com/documentation/metal/choosing_gpus_on_mac/device_selection_and_fallback_for_compute_processing">Device Selection and Fallback for Compute Processing</a></li>
</ul>

<p>There are also a few webpages with useful information about resource storage modes, about managing multiple displays and GPUs, about GPU bandwidth, about adding/removing external GPUs, and so on:</p>

<ul>
  <li><a href="https://developer.apple.com/documentation/metal/resource_objects/setting_resource_storage_modes/choosing_a_resource_storage_mode_in_macos">Choosing a Resource Storage Mode in macOS</a></li>
  <li><a href="https://developer.apple.com/documentation/metal/choosing_gpus_on_mac/about_multi-gpu_and_multi-display_setups">About Multi-GPU and Multi-Display Setups</a></li>
  <li><a href="https://developer.apple.com/documentation/metal/choosing_gpus_on_mac/about_gpu_bandwidth">About GPU Bandwidth</a></li>
  <li><a href="https://developer.apple.com/documentation/metal/choosing_gpus_on_mac/handling_external_gpu_additions_and_removals">Handling External GPU Additions and Removals</a></li>
  <li><a href="https://developer.apple.com/documentation/metal/choosing_gpus_on_mac/getting_different_types_of_gpus">Getting Different Types of GPUs</a></li>
  <li><a href="https://developer.apple.com/documentation/metal/choosing_gpus_on_mac/getting_the_gpu_that_drives_a_view_s_display">Getting the GPU that Drives a View’s Display</a></li>
</ul>

<p>Until next time!</p>

  </div>

  <!-- 
    

   -->

  <div class="a2a_kit a2a_kit_size_32 a2a_default_style"><br />
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_email"></a>
  </div>
  <script async src="https://static.addtoany.com/menu/page.js"></script>
</article>
      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper" align="center">

    <!-- <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p> -->

    <!-- Begin MailChimp Signup Form --><p>
    <link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
    <style type="text/css">
      #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    </style>
    <div id="mc_embed_signup">
      <form action="//github.us12.list-manage.com/subscribe/post?u=5daab344aba23020915a23c29&amp;id=69e4a7c3af" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
          <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Subscribe to be notified of new posts.</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
          <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_5daab344aba23020915a23c29_69e4a7c3af" tabindex="-1" value=""></div>
          <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
          </div>
      </form>
    </div>
    </p><!--End mc_embed_signup-->

    <!-- <h2 class="footer-heading">The Metal Framework</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <p class="rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></p>
        <ul class="contact-list">
          <li>
            
              The Metal Framework
            
            </li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/MetalKit"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">MetalKit</span></a>

          </li>
          
          
          <li>
            <a href="https://twitter.com/gpu3d"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">gpu3d</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        
          <a href="https://twitter.com/gpu3d"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">gpu3d</span></a>

        
        <p>Resources and tutorials for Metal, MetalKit and Metal Performance Shaders.
</p>
      </div>
    </div> -->

  </div>

</footer>


  </body>

</html>
